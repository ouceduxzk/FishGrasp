# 相机内参像素误差分析使用说明

## 概述

本工具提供了详细的相机内参标定误差分析功能，帮助评估相机标定的质量和精度。

## 功能特性

### 1. 重投影误差计算
- 计算每张标定图片的重投影误差
- 计算所有点的重投影误差分布
- 提供详细的误差统计信息

### 2. 内参精度评估
- 分析焦距参数 (fx, fy)
- 分析主点位置 (cx, cy)
- 计算焦距比例 (fx/fy)
- 评估畸变系数

### 3. 可视化分析
- 每张图片的误差柱状图
- 误差分布直方图
- 误差箱线图
- 内参信息表格

### 4. 标定质量评估
- 自动评估标定质量等级
- 提供改进建议

## 使用方法

### 方法一：使用独立分析脚本

```bash
cd hand_eye_calibrate
python pixel_error_analysis.py
```

### 方法二：集成到手眼标定中

```python
from hand_eye_calibrate import hand_eye_calibrate

# 启用像素误差分析
R, t, mtx, dist = hand_eye_calibrate(
    gripper_transform=gripper_transform, 
    enable_error_analysis=True
)
```

## 输出结果

### 1. 控制台输出

```
++++++++++开始像素误差分析++++++++++++++
总重投影误差: 0.3245 像素
误差统计:
  均值: 0.3124 像素
  标准差: 0.1234 像素
  最大值: 0.8765 像素
  最小值: 0.0123 像素
  中位数: 0.2987 像素

内参分析:
  fx: 615.23 像素
  fy: 614.87 像素
  cx: 320.45 像素
  cy: 240.12 像素
  焦距比例 (fx/fy): 1.0006

++++++++++标定质量评估++++++++++++++
✅ 标定质量：优秀 (重投影误差 < 0.5 像素)
✅ 焦距比例：正常 (fx/fy ≈ 1.0)
```

### 2. 可视化图表

生成 `camera_calibration_error_analysis.png` 文件，包含：

- **每张图片的重投影误差**：柱状图显示每张标定图片的误差
- **误差分布直方图**：显示所有点的误差分布情况
- **误差箱线图**：显示误差的统计分布
- **内参信息表格**：详细的内参和误差统计信息

## 误差分析指标

### 1. 重投影误差 (Reprojection Error)

重投影误差是衡量相机标定质量的最重要指标：

- **优秀**: < 0.5 像素
- **良好**: 0.5 - 1.0 像素
- **一般**: 1.0 - 2.0 像素
- **较差**: > 2.0 像素

### 2. 焦距比例 (fx/fy)

理想情况下，fx/fy 应该接近 1.0：

- **正常**: |fx/fy - 1.0| < 0.01
- **异常**: |fx/fy - 1.0| >= 0.01

### 3. 主点位置

主点 (cx, cy) 应该接近图像中心：

- 对于 640x480 图像，理想主点约为 (320, 240)
- 对于 1280x720 图像，理想主点约为 (640, 360)

## 常见问题及解决方案

### 1. 重投影误差过大

**可能原因：**
- 标定板质量差
- 标定图片数量不足
- 标定板姿态变化不够
- 相机移动过快导致图像模糊

**解决方案：**
- 使用高质量的标定板
- 增加标定图片数量（建议 20-30 张）
- 确保标定板覆盖整个视野
- 保持相机稳定，避免运动模糊

### 2. 焦距比例异常

**可能原因：**
- 相机传感器不是正方形像素
- 标定数据质量差
- 相机镜头畸变严重

**解决方案：**
- 检查相机规格，确认像素形状
- 重新采集高质量的标定数据
- 使用更精确的标定板

### 3. 主点位置异常

**可能原因：**
- 相机安装倾斜
- 标定板位置不准确
- 图像预处理问题

**解决方案：**
- 检查相机安装是否水平
- 确保标定板平整
- 检查图像预处理步骤

## 最佳实践

### 1. 标定数据采集

- **标定板质量**：使用高精度、高对比度的标定板
- **图片数量**：采集 20-30 张不同姿态的标定图片
- **覆盖范围**：确保标定板覆盖整个视野
- **姿态变化**：包含各种旋转和平移姿态
- **图像质量**：避免模糊、过曝或欠曝

### 2. 标定环境

- **光照条件**：均匀、稳定的光照
- **背景简单**：避免复杂的背景干扰
- **相机稳定**：避免振动和运动模糊
- **温度稳定**：避免温度变化影响相机参数

### 3. 结果验证

- **重投影误差**：应该 < 1.0 像素
- **焦距比例**：应该接近 1.0
- **主点位置**：应该接近图像中心
- **畸变系数**：应该在合理范围内

## 技术细节

### 重投影误差计算

重投影误差的计算公式：

```
error = ||observed_point - projected_point||_2
```

其中：
- `observed_point`: 图像中检测到的角点
- `projected_point`: 使用标定参数重投影的3D点

### 内参矩阵

相机内参矩阵格式：

```
K = [fx  0  cx]
    [ 0 fy  cy]
    [ 0  0   1]
```

其中：
- `fx, fy`: X和Y方向的焦距
- `cx, cy`: 主点坐标

### 畸变系数

OpenCV使用的畸变模型：

```
k1, k2, k3: 径向畸变系数
p1, p2: 切向畸变系数
```

## 文件结构

```
hand_eye_calibrate/
├── hand_eye_calibrate.py          # 主标定脚本（已集成误差分析）
├── pixel_error_analysis.py        # 独立误差分析脚本
├── 像素误差分析使用说明.md        # 本说明文档
├── collect_data/                  # 标定数据目录
│   ├── 0.jpg, 1.jpg, ...         # 标定图片
│   └── poses.txt                 # 机械臂位姿文件
└── camera_calibration_error_analysis.png  # 生成的误差分析图表
```

## 依赖库

```bash
pip install opencv-python numpy matplotlib
```

## 注意事项

1. **图像格式**：支持常见的图像格式（jpg, png, bmp等）
2. **标定板规格**：当前配置为 9x6 棋盘格，间距 24.75mm
3. **图片数量**：默认处理 20 张图片，可根据需要调整
4. **输出格式**：图表保存为 PNG 格式，分辨率 300 DPI
5. **中文字体**：图表支持中文显示，需要系统安装相应字体

## 更新日志

- **v1.0**: 初始版本，包含基本的误差分析功能
- **v1.1**: 添加可视化图表生成
- **v1.2**: 集成到手眼标定主脚本
- **v1.3**: 添加标定质量自动评估
