#!/usr/bin/env python3
"""
æ‰‹çœ¼æ ‡å®šè´¨é‡æ”¹è¿›å»ºè®®å·¥å…·

åŸºäºè¯¯å·®åˆ†æç»“æœï¼Œæä¾›å…·ä½“çš„æ”¹è¿›å»ºè®®
"""

import os
import numpy as np
import cv2

def analyze_calibration_quality():
    """åˆ†æå½“å‰æ ‡å®šè´¨é‡å¹¶æä¾›æ”¹è¿›å»ºè®®"""
    print("=" * 60)
    print("æ‰‹çœ¼æ ‡å®šè´¨é‡åˆ†æ")
    print("=" * 60)
    
    # å½“å‰æ ‡å®šç»“æœï¼ˆä»ä¸Šæ¬¡è¿è¡Œè·å¾—ï¼‰
    current_error = 29.9974  # åƒç´ 
    image_count = 16
    rotation_angle = 67.26  # åº¦
    translation_magnitude = 0.720  # ç±³
    
    print(f"å½“å‰æ ‡å®šç»“æœ:")
    print(f"  é‡æŠ•å½±è¯¯å·®: {current_error:.2f} åƒç´ ")
    print(f"  æ ‡å®šå›¾ç‰‡æ•°é‡: {image_count} å¼ ")
    print(f"  æ—‹è½¬è§’åº¦: {rotation_angle:.1f} åº¦")
    print(f"  å¹³ç§»è·ç¦»: {translation_magnitude:.3f} ç±³")
    
    print(f"\n" + "=" * 60)
    print("è´¨é‡è¯„ä¼°å’Œæ”¹è¿›å»ºè®®")
    print("=" * 60)
    
    # 1. é‡æŠ•å½±è¯¯å·®åˆ†æ
    print("1. é‡æŠ•å½±è¯¯å·®åˆ†æ:")
    if current_error < 1.0:
        print("   âœ… è¯¯å·®å¾ˆå°ï¼Œæ ‡å®šè´¨é‡ä¼˜ç§€")
    elif current_error < 2.0:
        print("   âœ… è¯¯å·®è¾ƒå°ï¼Œæ ‡å®šè´¨é‡è‰¯å¥½")
    elif current_error < 5.0:
        print("   âš ï¸  è¯¯å·®ä¸­ç­‰ï¼Œå»ºè®®ä¼˜åŒ–")
    else:
        print("   âŒ è¯¯å·®è¾ƒå¤§ï¼Œéœ€è¦æ”¹è¿›")
    
    if current_error >= 5.0:
        print("   æ”¹è¿›å»ºè®®:")
        print("   - å¢åŠ æ ‡å®šå›¾ç‰‡æ•°é‡åˆ°30-50å¼ ")
        print("   - ç¡®ä¿æ ‡å®šæ¿è¦†ç›–æ•´ä¸ªè§†é‡")
        print("   - æ£€æŸ¥æœºæ¢°è‡‚é‡å¤æ€§")
        print("   - æ”¹å–„æ ‡å®šç¯å¢ƒå…‰ç…§")
    
    # 2. æ ‡å®šå›¾ç‰‡æ•°é‡åˆ†æ
    print(f"\n2. æ ‡å®šå›¾ç‰‡æ•°é‡åˆ†æ:")
    if image_count < 20:
        print("   âš ï¸  å›¾ç‰‡æ•°é‡åå°‘ï¼Œå»ºè®®å¢åŠ åˆ°30-50å¼ ")
        print("   æ”¹è¿›å»ºè®®:")
        print("   - é‡‡é›†æ›´å¤šä¸åŒè§’åº¦çš„æ ‡å®šå›¾ç‰‡")
        print("   - ç¡®ä¿æ ‡å®šæ¿åœ¨å›¾åƒä¸­çš„ä½ç½®å¤šæ ·åŒ–")
        print("   - è¦†ç›–ç›¸æœºçš„æ•´ä¸ªè§†é‡èŒƒå›´")
    elif image_count < 30:
        print("   âœ… å›¾ç‰‡æ•°é‡é€‚ä¸­ï¼Œä½†å¯ä»¥å¢åŠ ")
    else:
        print("   âœ… å›¾ç‰‡æ•°é‡å……è¶³")
    
    # 3. æ—‹è½¬è§’åº¦åˆ†æ
    print(f"\n3. æ—‹è½¬è§’åº¦åˆ†æ:")
    if rotation_angle > 90:
        print("   âš ï¸  æ—‹è½¬è§’åº¦è¾ƒå¤§ï¼Œå¯èƒ½å½±å“æ ‡å®šç²¾åº¦")
        print("   æ”¹è¿›å»ºè®®:")
        print("   - ç¡®ä¿æœºæ¢°è‡‚ä½å§¿å˜åŒ–åˆç†")
        print("   - é¿å…æç«¯è§’åº¦")
    else:
        print("   âœ… æ—‹è½¬è§’åº¦åˆç†")
    
    # 4. å¹³ç§»è·ç¦»åˆ†æ
    print(f"\n4. å¹³ç§»è·ç¦»åˆ†æ:")
    if translation_magnitude > 1.0:
        print("   âš ï¸  å¹³ç§»è·ç¦»è¾ƒå¤§ï¼Œæ£€æŸ¥åæ ‡ç³»å®šä¹‰")
        print("   æ”¹è¿›å»ºè®®:")
        print("   - éªŒè¯å¤¹çˆªå˜æ¢çŸ©é˜µ")
        print("   - æ£€æŸ¥åæ ‡ç³»å®šä¹‰æ˜¯å¦æ­£ç¡®")
    else:
        print("   âœ… å¹³ç§»è·ç¦»åˆç†")
    
    return current_error, image_count

def generate_improved_calibration_script():
    """ç”Ÿæˆæ”¹è¿›çš„æ ‡å®šè„šæœ¬"""
    print(f"\n" + "=" * 60)
    print("ç”Ÿæˆæ”¹è¿›çš„æ ‡å®šè„šæœ¬")
    print("=" * 60)
    
    script_content = '''#!/usr/bin/env python3
"""
æ”¹è¿›çš„æ‰‹çœ¼æ ‡å®šè„šæœ¬

åŸºäºè´¨é‡åˆ†æç»“æœï¼Œä½¿ç”¨æ›´å¤šæ ‡å®šå›¾ç‰‡å’Œæ›´å¥½çš„å‚æ•°
"""

import os
import cv2
import numpy as np
from hand_eye_calibrate import hand_eye_calibrate

def improved_hand_eye_calibration():
    """æ”¹è¿›çš„æ‰‹çœ¼æ ‡å®š"""
    print("å¼€å§‹æ”¹è¿›çš„æ‰‹çœ¼æ ‡å®š...")
    
    # å¤¹çˆªå˜æ¢çŸ©é˜µ
    gripper_transform = {
        'R': np.array([[1, 0, 0],
                       [0, 1, 0], 
                       [0, 0, 1]]),
        't': np.array([0, 0, 0.195]).reshape(3, 1)
    }
    
    # æ‰§è¡Œæ‰‹çœ¼æ ‡å®šï¼ˆå¯ç”¨è¯¯å·®åˆ†æï¼‰
    R, t, mtx, dist = hand_eye_calibrate(
        gripper_transform=gripper_transform, 
        enable_error_analysis=True
    )
    
    print("\\næ”¹è¿›çš„æ‰‹çœ¼æ ‡å®šç»“æœ:")
    print("æ—‹è½¬çŸ©é˜µ:")
    print(R)
    print("å¹³ç§»å‘é‡:")
    print(t)
    
    return R, t, mtx, dist

if __name__ == "__main__":
    improved_hand_eye_calibration()
'''
    
    with open("improved_hand_eye_calibration.py", 'w', encoding='utf-8') as f:
        f.write(script_content)
    
    print("âœ… æ”¹è¿›çš„æ ‡å®šè„šæœ¬å·²ç”Ÿæˆ: improved_hand_eye_calibration.py")

def provide_data_collection_guidelines():
    """æä¾›æ•°æ®é‡‡é›†æŒ‡å¯¼"""
    print(f"\n" + "=" * 60)
    print("æ•°æ®é‡‡é›†æŒ‡å¯¼")
    print("=" * 60)
    
    guidelines = """
ğŸ“‹ æ”¹è¿›æ ‡å®šæ•°æ®é‡‡é›†çš„æŒ‡å¯¼åŸåˆ™ï¼š

1. ğŸ“¸ æ ‡å®šå›¾ç‰‡æ•°é‡
   - ç›®æ ‡ï¼š30-50å¼ é«˜è´¨é‡æ ‡å®šå›¾ç‰‡
   - å½“å‰ï¼š16å¼ ï¼ˆåå°‘ï¼‰
   - å»ºè®®ï¼šå¢åŠ 2-3å€

2. ğŸ¯ æ ‡å®šæ¿ä½ç½®
   - è¦†ç›–æ•´ä¸ªç›¸æœºè§†é‡
   - ä¸åŒè§’åº¦å’Œè·ç¦»
   - é¿å…è¾¹ç¼˜ä½ç½®
   - ç¡®ä¿æ ‡å®šæ¿æ¸…æ™°å¯è§

3. ğŸ¤– æœºæ¢°è‡‚ä½å§¿
   - ä½¿ç”¨ä¸åŒçš„å…³èŠ‚è§’åº¦
   - é¿å…å¥‡å¼‚ä½ç½®
   - ç¡®ä¿é‡å¤æ€§è‰¯å¥½
   - ä½å§¿å˜åŒ–è¦åˆç†

4. ğŸ’¡ ç¯å¢ƒæ¡ä»¶
   - ç¨³å®šçš„å…‰ç…§
   - é¿å…åå…‰å’Œé˜´å½±
   - å‡å°‘æŒ¯åŠ¨
   - ä¿æŒæ ‡å®šæ¿å¹³æ•´

5. ğŸ“ æ ‡å®šæ¿è´¨é‡
   - ä½¿ç”¨é«˜è´¨é‡æ‰“å°
   - ç¡®ä¿è§’ç‚¹æ¸…æ™°
   - é¿å…å˜å½¢
   - å®šæœŸæ£€æŸ¥ç²¾åº¦

6. ğŸ”§ æŠ€æœ¯å‚æ•°
   - ä½¿ç”¨äºšåƒç´ è§’ç‚¹æ£€æµ‹
   - ä¼˜åŒ–æ ‡å®šç®—æ³•å‚æ•°
   - éªŒè¯ç•¸å˜æ ¡æ­£æ•ˆæœ
   - æ£€æŸ¥åæ ‡ç³»å®šä¹‰
"""
    
    print(guidelines)

def create_quality_checklist():
    """åˆ›å»ºè´¨é‡æ£€æŸ¥æ¸…å•"""
    print(f"\n" + "=" * 60)
    print("æ ‡å®šè´¨é‡æ£€æŸ¥æ¸…å•")
    print("=" * 60)
    
    checklist = """
âœ… æ ‡å®šè´¨é‡æ£€æŸ¥æ¸…å•ï¼š

ğŸ“Š æ•°æ®è´¨é‡
â–¡ æ ‡å®šå›¾ç‰‡æ•°é‡ â‰¥ 30å¼ 
â–¡ æ ‡å®šæ¿è¦†ç›–æ•´ä¸ªè§†é‡
â–¡ è§’ç‚¹æ£€æµ‹æˆåŠŸç‡ > 90%
â–¡ æ ‡å®šæ¿æ¸…æ™°æ— æ¨¡ç³Š

ğŸ¤– æœºæ¢°è‡‚ç²¾åº¦
â–¡ é‡å¤æ€§è¯¯å·® < 0.1mm
â–¡ ä½å§¿å˜åŒ–åˆç†
â–¡ é¿å…å¥‡å¼‚ä½ç½®
â–¡ å…³èŠ‚è§’åº¦å¤šæ ·åŒ–

ğŸ“· ç›¸æœºè®¾ç½®
â–¡ ç„¦è·å›ºå®š
â–¡ æ›å…‰ç¨³å®š
â–¡ ç•¸å˜æ ¡æ­£æœ‰æ•ˆ
â–¡ å†…å‚æ ‡å®šå‡†ç¡®

ğŸŒ ç¯å¢ƒæ¡ä»¶
â–¡ å…‰ç…§ç¨³å®šå‡åŒ€
â–¡ æ— æŒ¯åŠ¨å¹²æ‰°
â–¡ æ ‡å®šæ¿å¹³æ•´
â–¡ èƒŒæ™¯ç®€æ´

ğŸ“ˆ ç»“æœéªŒè¯
â–¡ é‡æŠ•å½±è¯¯å·® < 2.0åƒç´ 
â–¡ æ—‹è½¬çŸ©é˜µæ­£äº¤æ€§ < 1e-6
â–¡ è¡Œåˆ—å¼æ¥è¿‘1.0
â–¡ å¹³ç§»å‘é‡åˆç†
"""
    
    print(checklist)

def main():
    """ä¸»å‡½æ•°"""
    print("æ‰‹çœ¼æ ‡å®šè´¨é‡æ”¹è¿›å»ºè®®å·¥å…·")
    print("åŸºäºå½“å‰æ ‡å®šç»“æœæä¾›å…·ä½“çš„æ”¹è¿›å»ºè®®")
    
    # åˆ†æå½“å‰æ ‡å®šè´¨é‡
    current_error, image_count = analyze_calibration_quality()
    
    # ç”Ÿæˆæ”¹è¿›è„šæœ¬
    generate_improved_calibration_script()
    
    # æä¾›æ•°æ®é‡‡é›†æŒ‡å¯¼
    provide_data_collection_guidelines()
    
    # åˆ›å»ºè´¨é‡æ£€æŸ¥æ¸…å•
    create_quality_checklist()
    
    print(f"\n" + "=" * 60)
    print("æ€»ç»“")
    print("=" * 60)
    
    print(f"å½“å‰æ ‡å®šè¯¯å·®: {current_error:.2f} åƒç´ ")
    print(f"æ ‡å®šå›¾ç‰‡æ•°é‡: {image_count} å¼ ")
    
    if current_error >= 5.0:
        print("\nğŸ¯ ä¸»è¦æ”¹è¿›æ–¹å‘:")
        print("1. å¢åŠ æ ‡å®šå›¾ç‰‡æ•°é‡åˆ°30-50å¼ ")
        print("2. æ”¹å–„æ ‡å®šæ•°æ®è´¨é‡")
        print("3. æ£€æŸ¥æœºæ¢°è‡‚é‡å¤æ€§")
        print("4. ä¼˜åŒ–æ ‡å®šç¯å¢ƒ")
        
        print("\nğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨:")
        print("1. é‡æ–°é‡‡é›†æ›´å¤šæ ‡å®šæ•°æ®")
        print("2. è¿è¡Œ improved_hand_eye_calibration.py")
        print("3. å¯¹æ¯”æ”¹è¿›å‰åçš„è¯¯å·®")
        print("4. æ ¹æ®ç»“æœè¿›ä¸€æ­¥ä¼˜åŒ–")
    else:
        print("\nâœ… å½“å‰æ ‡å®šè´¨é‡å¯ä»¥æ¥å—ï¼Œä½†ä»æœ‰æ”¹è¿›ç©ºé—´")
        print("å»ºè®®æŒ‰ç…§æŒ‡å¯¼åŸåˆ™è¿›è¡Œä¼˜åŒ–ä»¥è·å¾—æ›´å¥½çš„ç²¾åº¦")

if __name__ == "__main__":
    main()
