# 鱿鱼智能抓取系统

<div align="center">

**基于AI视觉与机器人控制的鱿鱼自动化分拣系统**

</div>

## 📋 项目概述

本项目是一个完整的AI驱动的鱿鱼自动化抓取与分拣系统，结合了深度学习视觉技术、3D点云处理和机器人控制。系统使用吸盘末端执行器实现对水产品（鱿鱼）的精准抓取，并完成自动化分拣任务。

### 🎯 核心目标

- **高精度检测**：在复杂水产环境中准确识别和定位鱿鱼
- **智能抓取**：预测最佳抓取点和抓取姿态
- **自动化流程**：从检测、分割、抓取到分拣的全自动化流水线
- **鲁棒性**：适应脏水、不同颜色和光照变化等真实工业场景

## 🎯 项目里程碑

### 里程碑 1：单臂机器人鱼类抓取系统 ✅

**目标**：实现单个机械臂对单一类型鱼类的自动化抓取

**技术方案**：
- 使用YOLOv8进行目标检测
- SAM模型实现实例分割
- EfficientNet预测抓取点
- PCA算法计算抓取姿态
- 单吸盘末端执行器
- 基于2D图像和深度信息的抓取策略

**当前状态**：主要功能已完成，系统可实现基本的检测-抓取-分拣流程

**应用场景**：单一品种鱿鱼的工业化分拣

---

### 里程碑 2：双臂灵巧手通用鱼类抓取系统（基于3D模型配准）🚧

**目标**：实现双臂机器人协同，对多种鱼类的通用化精准抓取

**核心技术突破**：
1. **3D模型配准技术**
   - 使用3D打印的鱼类模型作为先验知识
   - 实时点云获取与预处理
   - 点云配准算法（ICP/NDT/FGR）将检测点云与已知3D模型配准
   - 精确获取鱼体的完整6DOF位姿（3D位置 + 3D旋转）

2. **灵巧手抓取系统**
   - 多指灵巧手末端执行器
   - 基于配准结果的多点接触抓取规划
   - 力反馈控制，适应不同鱼体形状和刚度

3. **双臂协同控制**
   - 双臂任务分配与协调
   - 一臂固定、一臂操作的协同策略
   - 双臂同步抓取大型鱼体

4. **通用化能力**
   - 支持多种鱼类形态（扁平、圆柱、不规则）
   - 模型库管理，可扩展新鱼类品种
   - 自动识别鱼类类型并匹配对应3D模型

**技术优势**：
- **高精度**：6DOF位姿估计精度远超2D方法
- **鲁棒性**：利用3D几何约束，减少视觉错误
- **可扩展性**：通过增加3D模型支持新品种
- **适应性强**：灵巧手可适应复杂形状和抓取姿态

**工作流程**：
```
1. 目标检测（YOLO） → 定位鱼类区域
2. 点云分割 → 提取目标鱼体点云
3. 鱼类识别 → 确定鱼的种类
4. 模型检索 → 从模型库加载对应3D模型
5. 点云配准 → 将检测点云与3D模型配准
6. 位姿计算 → 获取精确的6DOF抓取姿态
7. 抓取规划 → 基于模型和位姿规划灵巧手抓取点
8. 双臂协同 → 执行抓取与放置任务
```

**当前状态**：规划阶段

**应用场景**：
- 多品种鱼类混合分拣
- 高精度鱼类加工（切割、去骨等预处理）
- 研究环境中的鱼类测量与分析

## ✨ 核心功能

### 1. 鱼类检测 (Fish Detection)
- **技术栈**：YOLOv8
- **功能**：实时检测视野内的鱿鱼目标，输出边界框和置信度
- **特性**：
  - 支持增量训练和难例挖掘
  - 硬负样本挖掘提升检测鲁棒性
  - 实时检测速度优化

### 2. 实例分割 (Instance Segmentation)
- **技术栈**：SAM (Segment Anything Model)
- **功能**：基于检测结果生成精确的鱼体轮廓掩码
- **特性**：
  - 像素级精确分割
  - 支持重叠目标分离
  - 自动过滤噪声点

### 3. 抓取点预测 (Grasp Point Prediction)
- **技术栈**：EfficientNet
- **功能**：预测鱿鱼表面最优的吸盘抓取位置
- **特性**：
  - 基于鱼体形状和纹理特征
  - 输出2D抓取点坐标
  - 考虑吸盘物理约束

### 4. 姿态估计 (Pose Estimation)
- **技术栈**：PCA (主成分分析)
- **功能**：计算鱼体主轴方向，确定抓取角度
- **特性**：
  - 基于分割掩码的几何分析
  - 鲁棒的方向估计
  - 与机器人坐标系对齐

### 5. 3D点云处理
- **技术栈**：RealSense深度相机 + Open3D
- **功能**：将2D检测结果映射到3D空间
- **特性**：
  - 手眼标定系统
  - 深度滤波和离群点去除
  - 相机-机器人坐标转换

### 6. 机器人控制
- **硬件**：Jaka机械臂 + 吸盘末端执行器
- **功能**：执行抓取和放置动作
- **特性**：
  - 动态抓取策略
  - 静态抓取策略
  - 轨迹规划与碰撞避免

## 🏗️ 系统架构

```
┌─────────────────┐
│  RealSense相机  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌──────────────────┐
│   YOLO检测      │────▶│   SAM分割        │
│  (YOLOv8)       │     │  (SAM Model)     │
└─────────────────┘     └────────┬─────────┘
                                 │
         ┌───────────────────────┴───────────────────┐
         │                                           │
         ▼                                           ▼
┌─────────────────┐                        ┌─────────────────┐
│  抓取点预测     │                        │  姿态估计       │
│ (EfficientNet)  │                        │    (PCA)        │
└────────┬────────┘                        └────────┬────────┘
         │                                          │
         └──────────────┬───────────────────────────┘
                        │
                        ▼
                ┌───────────────┐
                │  3D坐标转换   │
                │ (点云处理)    │
                └───────┬───────┘
                        │
                        ▼
                ┌───────────────┐
                │  机器人控制   │
                │  (Jaka臂)     │
                └───────────────┘
```

## 📊 工作流程

1. **初始化**：启动相机、加载模型、连接机器人
2. **场景感知**：获取RGB-D图像
3. **目标检测**：YOLO识别所有鱿鱼位置
4. **实例分割**：SAM生成每条鱼的精确掩码
5. **特征提取**：
   - EfficientNet预测抓取点
   - PCA计算鱼体方向
6. **3D映射**：将2D结果转换为3D机器人坐标
7. **运动规划**：计算抓取轨迹
8. **执行抓取**：机器人移动到目标位置并激活吸盘
9. **放置分拣**：将鱼放入指定容器位置

## 🚀 已完成功能

- ✅ 完整的鱼类检测pipeline（YOLO训练、测试、部署）
- ✅ SAM集成的实例分割系统
- ✅ 基于EfficientNet的抓取点预测模型
- ✅ 基于PCA的鱼体方向估计
- ✅ RealSense相机手眼标定系统
- ✅ 3D点云处理与坐标转换
- ✅ 单吸盘动态抓取策略
- ✅ 单吸盘静态抓取策略
- ✅ 实时可视化系统
- ✅ 硬负样本挖掘训练策略

## 🔧 待改进方向

### 1. 检测模块增强
- [ ] **数据集扩充**：收集更多样化的训练数据
  - 脏水、浑浊水质环境
  - 不同颜色的鱿鱼品种
  - 不同光照条件（强光、弱光、侧光）
  - 鱼体重叠、遮挡场景
- [ ] **模型优化**：
  - 数据增强策略（色彩抖动、模糊、噪声）
  - 域自适应技术
  - 小目标检测优化

### 2. 分割模块改进
- [ ] **更鲁棒的分割方案**：
  - 针对鱼体特征微调SAM模型
  - 集成边缘检测算法
  - 后处理优化（形态学操作、轮廓平滑）
  - 处理部分遮挡和重叠情况
- [ ] **形状完整性检测**：
  - 验证分割结果的完整性
  - 检测异常形状并重新分割

### 3. 双吸盘支持
- [ ] **双点抓取算法**：
  - 预测两个最佳抓取点位置
  - 计算两点间距离和夹角约束
  - 确保双点均在鱼体稳定区域
- [ ] **硬件集成**：
  - 双吸盘末端执行器控制
  - 独立气压控制系统
  - 抓取力反馈检测
- [ ] **策略优化**：
  - 针对不同大小鱼体的双点选择
  - 提高大型鱿鱼的抓取成功率

### 4. 智能分拣系统
- [ ] **有序放置算法**：
  - 容器内位置规划（行列布局）
  - 实时计算下一个可用放置位置
  - 避免鱼体相互重叠
- [ ] **分拣策略**：
  - 按大小分类（大、中、小）
  - 按质量分级（完整度、新鲜度）
  - 优化排列密度，提高空间利用率
- [ ] **多容器管理**：
  - 支持多个目标容器
  - 容器满载检测
  - 自动切换容器

### 5. 高级检测与抓取功能
- [ ] **定向边界框检测（Oriented Bounding Box Detection）**：
  - 使用YOLO进行旋转边界框检测，提高对倾斜目标的检测精度
  - 支持任意角度的目标定位，减少检测区域冗余
  - 优化对重叠和遮挡目标的检测效果
  - 集成OBB（Oriented Bounding Box）标注和训练流程
- [ ] **智能抓取策略（Grasp Strategy）**：
  - 多目标场景下的抓取优先级决策算法
  - 基于目标大小、位置、遮挡程度的抓取顺序优化
  - 动态评估下一个最佳抓取目标
  - 考虑机器人运动效率和抓取成功率的综合策略
- [ ] **抓取失败检测（Grasp Failure Detection）**：
  - 基于点云距离的抓取结果验证
  - 抓取前后点云对比分析
  - 实时检测吸盘是否成功吸附目标
  - 失败时自动触发重抓取策略
- [ ] **不可抓取目标跳过机制（Skip Ungraspable Targets）**：
  - 记录上次抓取失败的目标位置和特征w
  - 基于目标ID或位置匹配，自动跳过重复失败的鱼
  - 避免重复尝试抓取不可抓取的目标，提高整体效率
  - 支持失败目标黑名单管理，可手动重置或自动过期

### 6. 系统性能优化
- [ ] 推理速度优化（模型量化、TensorRT加速）
- [ ] 多线程并行处理
- [ ] 降低延迟，提高抓取节拍
- [ ] 异常处理和自动恢复机制

## 📁 项目结构

```
.
├── detection/              # 鱼类检测模块
│   ├── train_yolo.py      # YOLO训练脚本
│   ├── test_yolo.py       # 检测测试
│   ├── prepare_yolo_dataset.py
│   └── hard_negative_mining.py
├── landmarks/              # 关键点检测（实验性）
│   └── fish_landmark_detector.py
├── hand_eye_calibrate/     # 手眼标定系统
│   ├── hand_eye_calibrate.py
│   ├── camera_intrinsics.json
│   └── collect_data/
├── groundingdino/          # GroundingDINO配置
├── seg.py                  # 分割模块
├── squid_segment_sam.py    # SAM集成
├── dyna_grasp.py          # 动态抓取策略
├── static_grasp.py        # 静态抓取策略
├── mask_to_3d.py          # 2D到3D映射
├── point_cloud_utils.py   # 点云处理工具
├── PositionSolver.py      # 坐标求解器
├── realsense_capture.py   # 相机采集
└── util.py                # 通用工具函数
```

## 🛠️ 环境依赖

### 硬件要求
- Intel RealSense深度相机（D435/D455）
- Jaka协作机械臂
- 真空吸盘末端执行器
- NVIDIA GPU（推荐RTX 3060或更高）

### 软件环境
- Python 3.8+
- PyTorch 2.0+
- Ultralytics (YOLOv8)
- Segment Anything (SAM)
- Open3D
- OpenCV
- pyrealsense2

## 🚀 快速开始

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 手眼标定
```bash
cd hand_eye_calibrate
python hand_eye_calibrate.py
```

### 3. 运行演示
```bash
# 单目标静态抓取
bash run_demo_single_static.sh

# 单目标动态抓取（AI预测）
bash run_demo_single_ai.sh

# 动态多目标抓取
bash run_demo_dyna_ai.sh
```

### 4. 训练检测模型
```bash
cd detection
bash start_incremental_training.sh
```

## 📊 性能指标

| 指标 | 数值 |
|------|------|
| 检测精度 (mAP@0.5) | ~85% |
| 检测速度 | 30+ FPS |
| 抓取成功率 | ~80% |
| 平均抓取周期 | ~8秒 |

## 🤝 贡献

欢迎提交Issue和Pull Request来改进本项目！

## 📄 许可证

[添加适当的许可证信息]

## 📞 联系方式

[添加联系方式]

---

**注**：本项目处于持续开发中，部分功能仍在优化。
